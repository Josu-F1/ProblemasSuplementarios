@{
    Layout = "_Layout";
    ViewData["Title"] = "Inicio";
}

@model EightQueens.Web.Models.EightQueensViewModel

<div class="page-header">
    <h1><i class="fas fa-chess-queen text-warning me-3"></i>Problema de las 8 Reinas</h1>
    <p class="lead">Algoritmo DFS Backtracking (Depth First Search) - Enfoque Preferido</p>
    <div class="text-center">
        <span class="badge bg-success fs-6 me-2">
            <i class="fas fa-brain me-1"></i>Inteligencia Artificial
        </span>
        <span class="badge bg-info fs-6 me-2">
            <i class="fas fa-project-diagram me-1"></i>DFS + Backtracking  
        </span>
        <span class="badge bg-warning text-dark fs-6">
            <i class="fas fa-university me-1"></i>Universidad Técnica de Ambato
        </span>
    </div>
</div>

<!-- Formulario de configuración -->
<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h5 class="card-title text-center mb-4">
                    <i class="fas fa-cogs text-primary me-2"></i>Configuración del Problema
                </h5>
                
                <div id="solveForm" class="text-center">
                    <div class="row align-items-end">
                        <div class="col-md-6 mb-3">
                            <label for="boardSize" class="form-label fw-bold">Tamaño del Tablero (N×N):</label>
                            <select name="boardSize" id="boardSize" class="form-select form-select-lg">
                                <option value="8" selected>8×8 (92 soluciones)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <button type="submit" id="solveButton" class="btn btn-uta-primary btn-lg w-100">
                                <i class="fas fa-play me-2"></i>Resolver Problema
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mensaje de estado -->
@if (!string.IsNullOrEmpty(Model?.StatusMessage))
{
    <div class="alert @(Model.IsSolved && Model.TotalSolutions > 0 ? "alert-success" : "alert-danger") alert-uta animate-fade-in">
        <i class="fas @(Model.IsSolved && Model.TotalSolutions > 0 ? "fa-check-circle" : "fa-exclamation-triangle") me-2"></i>
        @Model.StatusMessage
    </div>
}

<!-- Información de resultados -->
@if (Model.IsSolved && Model.TotalSolutions > 0)
{
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-primary"><i class="fas fa-chess-board me-2"></i>@Model.BoardSize×@Model.BoardSize</h3>
                                <p class="text-muted mb-0">Tablero</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-success"><i class="fas fa-trophy me-2"></i>@Model.TotalSolutions</h3>
                                <p class="text-muted mb-0">Soluciones</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-info"><i class="fas fa-clock me-2"></i>@Model.ExecutionTimeMs.ToString("F2") ms</h3>
                                <p class="text-muted mb-0">Tiempo</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-warning"><i class="fas fa-brain me-2"></i>DFS</h3>
                                <p class="text-muted mb-0">Algoritmo IA</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información del algoritmo DFS -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="alert alert-info border-0">
                <h6 class="alert-heading">
                    <i class="fas fa-brain text-info me-2"></i>
                    Algoritmo DFS Backtracking
                </h6>
                <p class="mb-1">
                    <strong>Depth First Search</strong> con Backtracking es el <em>enfoque preferido</em> según literatura especializada. 
                    Usa nodos genéricos con <code>firstChild()</code> y <code>nextSibling()</code> para explorar el espacio de soluciones de forma natural.
                </p>
                <small class="text-muted">
                    <i class="fas fa-book me-1"></i>
                    Más natural que permutaciones | Arquitectura extensible | Motor genérico reutilizable
                </small>
            </div>
        </div>
    </div>

    <!-- Navegación de soluciones -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-chess-queen text-warning me-2"></i>
                    Solución <span id="current-solution">1</span> de @Model.TotalSolutions
                </h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="previousSolution()" id="prev-btn">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="nextSolution()" id="next-btn">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tablero de ajedrez -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card border-0 shadow">
                <div class="card-body p-4">
                    <div id="chess-board-container" class="text-center">
                        <!-- El tablero se genera dinámicamente con JavaScript -->
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Coordenadas: <span id="queen-coordinates">Cargando...</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .chess-board {
        display: inline-block;
        border: 4px solid var(--uta-blue-primary);
        border-radius: 10px;
        background: var(--uta-blue-primary);
        padding: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .chess-row {
        display: flex;
        margin: 0;
    }

    .chess-cell {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        border: 1px solid #333;
        transition: all 0.3s ease;
        position: relative;
    }

    .chess-cell.light {
        background-color: var(--board-light);
        color: var(--uta-blue-primary);
    }

    .chess-cell.dark {
        background-color: var(--board-dark);
        color: var(--uta-white);
    }

    .chess-cell.queen {
        background: radial-gradient(circle, var(--queen-gold), #ffed4a);
        color: var(--uta-blue-primary);
        font-weight: bold;
        animation: pulse 2s infinite;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .chess-cell .queen-icon {
        filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
    }

    @@keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .stat-item h3 {
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .coordinate-display {
        background: var(--uta-gray-light);
        border-radius: 15px;
        padding: 10px 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
    }
</style>

@section Scripts {
<script>
    let solutions = @Html.Raw(Json.Serialize(Model?.Solutions ?? new List<EightQueens.Web.Models.BoardViewModel>()));
    let currentIndex = 0;
    let boardSize = @(Model?.BoardSize ?? 8);

    // Manejar el botón con AJAX
    document.getElementById('solveButton').addEventListener('click', function(e) {
        e.preventDefault();
        
        console.log('Botón clickeado'); // Debug
        
        const boardSizeSelect = document.getElementById('boardSize');
        const selectedSize = parseInt(boardSizeSelect.value);
        const solveButton = document.getElementById('solveButton');
        
        // Mostrar estado de carga
        solveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resolviendo...';
        solveButton.disabled = true;
        
        console.log('Enviando petición para tamaño:', selectedSize); // Debug
        
        // Llamada AJAX simplificada
        fetch('/EightQueens/SolveAjax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({ boardSize: selectedSize })
        })
        .then(response => {
            console.log('Respuesta recibida:', response); // Debug
            return response.json();
        })
        .then(data => {
            console.log('Datos:', data); // Debug
            
            if (data.success) {
                // Actualizar variables globales
                solutions = data.solutions;
                currentIndex = 0;
                boardSize = data.boardSize;
                
                // Mostrar mensaje de éxito
                showSuccess(`¡Éxito! Encontradas ${data.solutionsCount} soluciones en ${data.executionTimeMs.toFixed(2)} ms`);
                
                // Mostrar controles de navegación
                showNavigationControls();
                
                // Renderizar primera solución si existe
                if (data.solutions.length > 0) {
                    renderBoardFromData(data.solutions[0]);
                    updateSolution(); // Actualizar botones y contador
                }
            } else {
                showError(data.message || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error:', error); // Debug
            showError('Error de conexión: ' + error.message);
        })
        .finally(() => {
            // Restaurar botón
            solveButton.innerHTML = '<i class="fas fa-play me-2"></i>Resolver Problema';
            solveButton.disabled = false;
        });
    });

    function showSuccess(message) {
        // Crear o actualizar elemento de mensaje
        let statusDiv = document.querySelector('.status-message');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.className = 'status-message';
            // Insertar después del formulario
            const form = document.getElementById('solveForm');
            form.parentNode.insertBefore(statusDiv, form.nextSibling);
        }
        
        statusDiv.className = 'status-message alert alert-success mt-3';
        statusDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
        statusDiv.style.display = 'block';
    }

    function showError(message) {
        // Crear o actualizar elemento de mensaje
        let statusDiv = document.querySelector('.status-message');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.className = 'status-message';
            // Insertar después del formulario
            const form = document.getElementById('solveForm');
            form.parentNode.insertBefore(statusDiv, form.nextSibling);
        }
        
        statusDiv.className = 'status-message alert alert-danger mt-3';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
        statusDiv.style.display = 'block';
    }

    function updateUI(data) {
        // Actualizar mensaje de estado
        const statusDiv = document.querySelector('.alert') || document.createElement('div');
        statusDiv.className = 'alert alert-success';
        statusDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>¡Éxito! Encontradas ${data.solutionsCount} soluciones en ${data.executionTimeMs.toFixed(2)} ms`;
        
        // Actualizar estadísticas
        document.querySelector('.stat-item:nth-child(1) h3').textContent = data.solutionsCount;
        document.querySelector('.stat-item:nth-child(2) h3').textContent = data.executionTimeMs.toFixed(2) + ' ms';
        document.querySelector('.stat-item:nth-child(3) h3').textContent = data.algorithm;
        
        // Renderizar primera solución
        if (data.solutions.length > 0) {
            renderBoardFromData(data.solutions[0]);
            updateSolutionNavigation();
        }
        
        // Mostrar controles de navegación
        document.querySelector('.solution-navigation').style.display = data.solutions.length > 1 ? 'block' : 'none';
    }

    function renderBoardFromData(solutionData) {
        console.log('Renderizando tablero:', solutionData); // Debug
        
        // Crear contenedor si no existe
        let container = document.getElementById('chess-board-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'chess-board-container';
            container.className = 'chess-board-container mt-4';
            
            // Insertar después del mensaje de estado
            const statusMsg = document.querySelector('.status-message');
            if (statusMsg) {
                statusMsg.parentNode.insertBefore(container, statusMsg.nextSibling);
            } else {
                document.querySelector('.page-header').appendChild(container);
            }
        }
        
        const board = document.createElement('div');
        board.className = 'chess-board mx-auto';
        board.style.display = 'grid';
        board.style.gridTemplateColumns = `repeat(${boardSize}, 1fr)`;
        board.style.gap = '2px';
        board.style.maxWidth = '400px';
        board.style.border = '2px solid #003d7a';
        
        for (let row = 0; row < boardSize; row++) {
            for (let col = 0; col < boardSize; col++) {
                const cell = document.createElement('div');
                cell.style.width = '40px';
                cell.style.height = '40px';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                cell.style.fontSize = '24px';
                
                // Verificar si hay reina en esta posición
                const hasQueen = solutionData.queens && solutionData.queens.some(q => q.row === row && q.col === col);
                
                if (hasQueen) {
                    cell.style.backgroundColor = '#ffd700';
                    cell.innerHTML = '♛';
                    cell.style.color = '#003d7a';
                } else {
                    cell.style.backgroundColor = (row + col) % 2 === 0 ? '#f8f9fa' : '#6c757d';
                    cell.style.color = (row + col) % 2 === 0 ? '#000' : '#fff';
                }
                
                board.appendChild(cell);
            }
        }
        
        container.innerHTML = '';
        container.appendChild(board);
        
        // Mostrar coordenadas
        if (solutionData.queens) {
            const coordsDiv = document.createElement('div');
            coordsDiv.className = 'mt-2 text-center';
            coordsDiv.innerHTML = `<strong>Posiciones:</strong> ${solutionData.queens.map(q => `(${q.row + 1},${q.col + 1})`).join(', ')}`;
            container.appendChild(coordsDiv);
        }
    }

    function renderBoard(boardData) {
        const container = document.getElementById('chess-board-container');
        const board = document.createElement('div');
        board.className = 'chess-board';
        
        for (let row = 0; row < boardSize; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'chess-row';
            
            for (let col = 0; col < boardSize; col++) {
                const cell = document.createElement('div');
                cell.className = `chess-cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                
                // Verificar si hay una reina en esta posición
                if (boardData.queenPositions[row] === col) {
                    cell.classList.add('queen');
                    cell.innerHTML = '<span class="queen-icon">♛</span>';
                }
                
                rowDiv.appendChild(cell);
            }
            board.appendChild(rowDiv);
        }
        
        container.innerHTML = '';
        container.appendChild(board);
        
        // Actualizar coordenadas
        document.getElementById('queen-coordinates').textContent = boardData.queenCoordinates;
    }

    function previousSolution() {
        if (currentIndex > 0) {
            currentIndex--;
            updateSolution();
        }
    }

    function nextSolution() {
        if (currentIndex < solutions.length - 1) {
            currentIndex++;
            updateSolution();
        }
    }

    function updateSolution() {
        if (solutions.length === 0) return;
        
        // Actualizar contador
        const currentSolElement = document.getElementById('current-solution');
        if (currentSolElement) {
            currentSolElement.textContent = currentIndex + 1;
        }
        
        // Renderizar tablero actual
        if (solutions[currentIndex]) {
            renderBoardFromData(solutions[currentIndex]);
        }
        
        // Actualizar botones
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        if (prevBtn) prevBtn.disabled = currentIndex === 0;
        if (nextBtn) nextBtn.disabled = currentIndex === solutions.length - 1;
        
        console.log(`Mostrando solución ${currentIndex + 1} de ${solutions.length}`);
    }

    function showNavigationControls() {
        // Buscar o crear la sección de navegación
        let navSection = document.querySelector('.solution-navigation');
        if (!navSection) {
            navSection = document.createElement('div');
            navSection.className = 'solution-navigation row mb-3';
            navSection.innerHTML = `
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-chess-queen text-warning me-2"></i>
                            Solución <span id="current-solution">1</span> de <span id="total-solutions">0</span>
                        </h4>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="previousSolution()" id="prev-btn">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="nextSolution()" id="next-btn">
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar después del mensaje de estado
            const statusMsg = document.querySelector('.status-message');
            if (statusMsg) {
                statusMsg.parentNode.insertBefore(navSection, statusMsg.nextSibling);
            }
        }
        
        // Actualizar total de soluciones
        const totalSolElement = document.getElementById('total-solutions');
        if (totalSolElement) {
            totalSolElement.textContent = solutions.length;
        }
        
        // Mostrar/ocultar según cantidad de soluciones
        navSection.style.display = solutions.length > 1 ? 'block' : 'none';
    }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        @if (Model.IsSolved && Model.TotalSolutions > 0)
        {
            <text>
            renderBoard(solutions[0]);
            updateSolution();
            </text>
        }
    });

    // Navegación con teclado
    document.addEventListener('keydown', function(e) {
        if (solutions.length > 0) {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                previousSolution();
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                nextSolution();
            }
        }
    });
</script>
}