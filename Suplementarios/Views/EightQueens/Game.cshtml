@model EightQueens.Web.Models.EightQueensViewModel

@{
    ViewData["Title"] = "8 Reinas - Juego";
}

<div class="queens-game-container">
    <div class="game-header text-center mb-4">
        <h1 class="display-4 text-warning mb-3">
            <i class="fas fa-chess-queen me-3"></i>8 Reinas
        </h1>
        <p class="lead text-muted mb-4">Algoritmo DFS Backtracking - Encuentra todas las soluciones</p>
        
        <div class="game-controls mb-4">
            <button type="button" class="btn btn-warning btn-lg px-5 py-3" onclick="solveQueens()">
                <i class="fas fa-play me-2"></i>Resolver 8 Reinas
            </button>
        </div>
        
        <div class="algorithm-info">
            <span class="badge bg-info fs-6 me-2">
                <i class="fas fa-brain me-1"></i>DFS Backtracking
            </span>
            <span class="badge bg-secondary fs-6 me-2">
                <i class="fas fa-clock me-1"></i>O(N!) Complejidad
            </span>
            <span class="badge bg-success fs-6">
                <i class="fas fa-check-circle me-1"></i>Poda Inteligente
            </span>
        </div>
    </div>

<!-- Estado y resultados -->
@if (!string.IsNullOrEmpty(Model?.StatusMessage))
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert @(Model.IsSolved ? "alert-success" : "alert-info") alert-dismissible fade show" role="alert">
                <strong>@Model.StatusMessage</strong>
                @if (Model.IsSolved && Model.ExecutionTimeMs > 0)
                {
                    <br><small>Tiempo de ejecución: @Model.ExecutionTimeMs.ToString("F2") ms</small>
                }
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
}

    <!-- Soluciones encontradas -->
    @if (Model?.IsSolved == true && Model.Solutions?.Any() == true)
    {
        <div class="solutions-section">
            <div class="text-center mb-4">
                <h3 class="text-success mb-3">
                    <i class="fas fa-trophy me-2"></i>
                    ¡@Model.Solutions.Count Soluciones Encontradas!
                </h3>
                <p class="text-muted mb-4">
                    Tiempo: <strong>@Model.ExecutionTimeMs.ToString("F2") ms</strong> | 
                    Algoritmo: <strong>@Model.Algorithm</strong>
                </p>
                
                @if (Model.Solutions.Count > 1)
                {
                    <div class="solution-navigation mb-4">
                        <button type="button" class="btn btn-outline-warning btn-lg me-3" onclick="previousSolution()">
                            <i class="fas fa-chevron-left me-2"></i>Anterior
                        </button>
                        <span class="btn btn-warning btn-lg me-3" id="solutionCounter">
                            <i class="fas fa-chess-queen me-2"></i>1 / @Model.Solutions.Count
                        </span>
                        <button type="button" class="btn btn-outline-warning btn-lg" onclick="nextSolution()">
                            Siguiente<i class="fas fa-chevron-right ms-2"></i>
                        </button>
                    </div>
                }
            </div>
            
            <div class="board-display-container">
                @for (int i = 0; i < Model.Solutions.Count; i++)
                {
                    <div class="solution-board text-center @(i == 0 ? "" : "d-none")" id="solution-@i">
                        <h4 class="text-warning mb-4">
                            <i class="fas fa-crown me-2"></i>Solución #@Model.Solutions[i].SolutionNumber
                        </h4>
                        <div class="board-container-large d-flex justify-content-center">
                            @await Html.PartialAsync("_ChessBoard", Model.Solutions[i])
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Sección dinámica para mostrar soluciones -->
    <div id="solutionsDisplay" class="d-none">
        <div class="solutions-section">
            <div class="text-center mb-4">
                <h3 class="text-success mb-3">
                    <i class="fas fa-trophy me-2"></i>
                    <span id="solutionsCount">92 Soluciones Encontradas!</span>
                </h3>
                <p class="text-muted mb-4">
                    Tiempo: <strong><span id="executionTime">0</span> ms</strong> | 
                    Algoritmo: <strong>DFS Backtracking</strong>
                </p>
                
                <div class="solution-navigation mb-4">
                    <button type="button" class="btn btn-outline-warning btn-lg me-3" onclick="previousSolution()" id="prevBtn">
                        <i class="fas fa-chevron-left me-2"></i>Anterior
                    </button>
                    <span class="btn btn-warning btn-lg me-3" id="solutionCounter">
                        <i class="fas fa-chess-queen me-2"></i>1 / 92
                    </span>
                    <button type="button" class="btn btn-outline-warning btn-lg" onclick="nextSolution()" id="nextBtn">
                        Siguiente<i class="fas fa-chevron-right ms-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="board-display-container text-center">
                <h4 class="text-warning mb-4">
                    <i class="fas fa-crown me-2"></i><span id="currentSolutionTitle">Solución #1</span>
                </h4>
                <div class="board-container-large d-flex justify-content-center" id="chessBoard">
                    <!-- El tablero se generará aquí dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <div id="emptyState" class="empty-state text-center py-5">
        <i class="fas fa-chess-queen display-1 text-muted mb-4"></i>
        <h4 class="text-muted mb-3">Presiona "Resolver 8 Reinas" para comenzar</h4>
        <p class="text-muted">El algoritmo DFS Backtracking encontrará todas las 92 soluciones posibles</p>
    </div>

    <!-- Loading -->
    <div id="loadingState" class="d-none text-center py-5">
        <div class="spinner-border text-warning" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h4 class="text-warning mt-3">Resolviendo...</h4>
        <p class="text-muted">El algoritmo está encontrando todas las soluciones posibles</p>
    </div>
</div>

@section Scripts {
    <script>
        let currentSolutionIndex = 0;
        let allSolutions = [];
        let totalSolutions = 0;
        
        function solveQueens() {
            // Mostrar loading
            document.getElementById('emptyState').classList.add('d-none');
            document.getElementById('solutionsDisplay').classList.add('d-none');
            document.getElementById('loadingState').classList.remove('d-none');
            
            fetch('/EightQueens/SolveAjax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ boardSize: 8 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allSolutions = data.solutions;
                    totalSolutions = data.solutionsCount;
                    currentSolutionIndex = 0;
                    
                    // Actualizar información
                    document.getElementById('solutionsCount').textContent = `${totalSolutions} Soluciones Encontradas!`;
                    document.getElementById('executionTime').textContent = data.executionTimeMs.toFixed(2);
                    
                    // Mostrar primera solución
                    showSolution(0);
                    
                    // Mostrar la sección de soluciones
                    document.getElementById('loadingState').classList.add('d-none');
                    document.getElementById('solutionsDisplay').classList.remove('d-none');
                } else {
                    alert('Error: ' + data.message);
                    document.getElementById('loadingState').classList.add('d-none');
                    document.getElementById('emptyState').classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al resolver el problema');
                document.getElementById('loadingState').classList.add('d-none');
                document.getElementById('emptyState').classList.remove('d-none');
            });
        }
        
        function showSolution(index) {
            if (index < 0 || index >= totalSolutions) return;
            
            currentSolutionIndex = index;
            const solution = allSolutions[index];
            
            // Actualizar título y contador
            document.getElementById('currentSolutionTitle').textContent = `Solución #${solution.solutionNumber}`;
            document.getElementById('solutionCounter').innerHTML = `<i class="fas fa-chess-queen me-2"></i>${index + 1} / ${totalSolutions}`;
            
            // Generar tablero
            const board = createChessBoard(solution.queens);
            document.getElementById('chessBoard').innerHTML = board;
            
            // Actualizar botones
            document.getElementById('prevBtn').disabled = (index === 0);
            document.getElementById('nextBtn').disabled = (index === totalSolutions - 1);
        }
        
        function nextSolution() {
            if (currentSolutionIndex < totalSolutions - 1) {
                showSolution(currentSolutionIndex + 1);
            }
        }
        
        function previousSolution() {
            if (currentSolutionIndex > 0) {
                showSolution(currentSolutionIndex - 1);
            }
        }
        
        function createChessBoard(queens) {
            let board = '<div class="chess-board">';
            
            for (let row = 0; row < 8; row++) {
                board += '<div class="board-row-custom">';
                for (let col = 0; col < 8; col++) {
                    const hasQueen = queens.some(q => q.row === row && q.col === col);
                    const isLight = (row + col) % 2 === 0;
                    const cellClass = `chess-cell-custom ${isLight ? 'light' : 'dark'} ${hasQueen ? 'has-queen' : ''}`;
                    
                    board += `<div class="${cellClass}" data-row="${row}" data-col="${col}">`;
                    if (hasQueen) {
                        board += '<i class="fas fa-chess-queen queen-icon-custom"></i>';
                    }
                    board += '</div>';
                }
                board += '</div>';
            }
            
            board += '</div>';
            return board;
        }
    </script>
    
    <style>
        .queens-game-container {
            min-height: 80vh;
            padding: 2rem 0;
        }
        
        .game-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-radius: 20px;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.2);
        }
        
        .game-controls .btn {
            border-radius: 50px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .game-controls .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .algorithm-info .badge {
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            font-weight: 500;
        }
        
        .solutions-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 3rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .solution-navigation .btn {
            border-radius: 50px;
            font-weight: 600;
            padding: 1rem 2rem;
            border-width: 2px;
        }
        
        .board-container-large {
            padding: 2rem;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: inline-block;
            margin: 0 auto;
        }
        
        .empty-state {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            margin: 3rem 0;
        }
        
        .mini-board {
            display: inline-block;
            border: 2px solid #333;
        }
        
        .board-row {
            display: flex;
        }
        
        .mini-cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .mini-cell.light {
            background-color: #f0d9b5;
        }
        
        .mini-cell.dark {
            background-color: #b58863;
        }
        
        /* Animaciones suaves */
        .solution-board {
            transition: all 0.5s ease;
        }
        
        .board-container-large {
            animation: boardAppear 0.6s ease-out;
        }
        
        @@keyframes boardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* CSS para tableros generados dinámicamente */
        .chess-board {
            display: inline-block;
            border: 3px solid #8B4513;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: #8B4513;
            padding: 4px;
            animation: boardAppear 0.6s ease-out;
        }
        
        .board-row-custom {
            display: flex;
            margin: 0;
        }
        
        .chess-cell-custom {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .chess-cell-custom.light {
            background-color: #f0d9b5;
        }
        
        .chess-cell-custom.dark {
            background-color: #b58863;
        }
        
        .chess-cell-custom.has-queen {
            background-color: #ffd700 !important;
            box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .queen-icon-custom {
            font-size: 42px;
            color: #8B0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: placeQueen 0.5s ease-in-out;
        }
        
        .chess-cell-custom:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        /* Loading spinner personalizado */
        .spinner-border {
            animation: spin-custom 1s linear infinite;
        }
        
        @@keyframes spin-custom {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
}